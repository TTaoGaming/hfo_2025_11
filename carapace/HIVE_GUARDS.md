---
hexagon:
  ontos:
    id: 77889f8d-e6e4-4861-bdba-f749b760aa63
    type: md
    owner: Swarmlord
  chronos:
    status: active
    urgency: 0.5
    decay: 0.5
    created: '2025-11-23T10:21:31.550000+00:00'
    generation: 51
  topos:
    address: carapace/HIVE_GUARDS.md
    links: []
  telos:
    viral_factor: 0.0
    meme: HIVE_GUARDS.md
---


# ğŸ›¡ï¸ Carapace Hive Guards

> **Status**: Active
> **Role**: Automated Defense System
> **Tools**: Pre-commit, Ruff, Black, Mypy, Venom

## ğŸ§¬ Overview
The **Hive Guards** are the automated immune system of Hive Fleet Obsidian. They run before every commit to ensure code quality, consistency, and stability.

## ğŸ›¡ï¸ The Guard Layers

### 1. ğŸ§¹ Hygiene (Pre-Commit Hooks)
*   **Trailing Whitespace**: Removes useless whitespace.
*   **End of File Fixer**: Ensures files end with a newline.
*   **Check YAML**: Validates YAML syntax (critical for `models.yaml` and `registry.yaml`).
*   **Large Files**: Prevents accidental commit of large binaries (>1MB).

### 2. âš¡ Static Analysis (Linting)
*   **Ruff**: Extremely fast Python linter. Replaces Flake8, isort, etc.
    *   *Action*: Auto-fixes import sorting and common errors.
*   **Black**: The uncompromising code formatter.
    *   *Action*: Enforces consistent style (PEP 8).
*   **Mypy**: Static type checker.
    *   *Action*: Enforces type safety (Pydantic compatibility).

### 3. ğŸ§ª Venom Injection (Smoke Tests)
*   **Venom Smoke Tests**: Runs `python genesis.py --venom` before every commit.
    *   *Action*: Verifies that the core anatomy (Brain, Body, Nerves) is functional.
    *   *Policy*: If the anatomy is broken, the commit is rejected.

### 4. ğŸ”’ Security Guard (Secrets)
*   **Detect Secrets**: Scans for hardcoded API keys, passwords, and model names.
    *   *Action*: Prevents committing secrets to the repo.
    *   *Policy*: Use environment variables (`.env`) for all sensitive data.

### 5. ğŸ§  Brain Integrity Guard (Registry)
*   **Concept Validation**: Enforces the "Intent-Based Engineering" structure in `brain/`.
*   **Rule**: Every concept must have:
    1.  **Gherkin Feature** (`.feature`): Defines behavior and requirements.
    2.  **Executive Summary** (`.md`): Contains high-level overview and **Mermaid** visualization.
*   **Registry**: Validates against `brain/concepts.yaml`.
*   **Slop Detection**: Flags any file in `brain/` that is not registered.
*   **Command**: `./carapace/hive_guards/guard_brain.py`

### 6. ğŸ§œâ€â™€ï¸ Mermaid Guard (Visualization)
*   **Syntax Validation**: Scans `brain/*.md` for `mermaid` code blocks.
*   **Type Check**: Ensures diagrams start with valid types (e.g., `graph`, `sequenceDiagram`).
*   **Empty Check**: Flags empty diagram blocks.
*   **Command**: `./carapace/hive_guards/guard_mermaid.py`

### 7. ğŸ”— Intent-Implementation Link Guard
*   **Parity Check**: Ensures every Gherkin Feature (`brain/*.feature`) has a corresponding Python implementation (`body/hands/*.py`).
*   **Rule**: "The Word becomes Flesh". No Intent without Body.
*   **Command**: `./carapace/hive_guards/guard_gherkin_parity.py`

### 8. ğŸ·ï¸ Stigmergy Header Guard
*   **Traceability**: Ensures every Python file in `body/hands/` has a docstring linking it to an Intent.
*   **Format**: Must contain `Intent: ...` or `Generated by Genesis`.
*   **Rule**: No "Wild Code". Everything must be linked to the Brain.
*   **Command**: `./carapace/hive_guards/guard_stigmergy_headers.py`

### 9. ğŸ‘ï¸ Reality Guard (Venom)
*   **Brutal Truth**: Verifies the physics of the system (Concurrency, Stigmergy, Tooling).
*   **Action**: Runs actual async tasks, NATS messages, and Web searches.
*   **Command**: `python venom/guard_reality.py`

## ğŸ”® Future Guards & Immunizers (Roadmap)
*Based on HFO Gem Evolution Pain Points*

### 1. ğŸŒ€ Hallucination Death Spiral Immunizer
*   **Pain Point**: Agents getting stuck in loops, repeating the same error or outputting infinite text.
*   **Solution**: Runtime monitor (Immunizer) that tracks:
    *   **Repetition Rate**: N-gram overlap with previous outputs.
    *   **Cyclic Tool Calls**: Repeating the same tool with same args > 3 times.
    *   **Action**: Circuit breaker that kills the agent and triggers a "Reflexion" step.

### 2. ğŸ•¸ï¸ Link Rot Guard
*   **Pain Point**: Markdown files referencing non-existent files or anchors.
*   **Solution**: Static analysis that parses `[Link](path)` and verifies `path` exists.

### 3. ğŸ Code Block Validator
*   **Pain Point**: Python code snippets in Markdown that are syntactically invalid.
*   **Solution**: Extract `python` blocks from `.md` and run `ast.parse()` on them.

### 4. ğŸ“„ Gherkin-Code Parity Guard
*   **Pain Point**: Implementation drifting away from Intent.
*   **Solution**: Check that every `Feature` in `brain/` has a corresponding `Test` in `venom/` or `Implementation` in `body/`.

## ğŸ› ï¸ Usage

### Installation
```bash
pip install pre-commit
pre-commit install
```

### Manual Run
To run the guards on all files without committing:
```bash
pre-commit run --all-files
```

### Bypass (Emergency Only)
If you must bypass the guards (e.g., for a WIP save):
```bash
git commit -m "wip" --no-verify
```
**Warning**: Bypassing guards weakens the Hive. Use sparingly.
